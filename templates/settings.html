{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Attendance Settings - System Configuration{% endblock %}

{% block page_title %}Attendance Settings{% endblock %}
{% block page_subtitle %}Configure system parameters and attendance rules{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-lg-3 mb-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-cog me-2"></i>Settings Categories
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="#attendance-rules" class="list-group-item list-group-item-action active">
                            <i class="fas fa-user-clock me-2"></i>
                            Attendance Rules
                        </a>
                        <a href="#security-settings" class="list-group-item list-group-item-action">
                            <i class="fas fa-shield-alt me-2"></i>
                            Security Settings
                        </a>
                        <a href="#notification-settings" class="list-group-item list-group-item-action">
                            <i class="fas fa-bell me-2"></i>
                            Notifications
                        </a>
                        <a href="#system-config" class="list-group-item list-group-item-action">
                            <i class="fas fa-sliders-h me-2"></i>
                            System Configuration
                        </a>
                    </div>
                </div>
            </div>

            <!-- Settings Status -->
            <div class="card dashboard-card mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Current Status
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small text-muted">System Status</span>
                            <span class="badge bg-success">Active</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small text-muted">Last Updated</span>
                            <span class="small text-muted">{% now "M d, Y" %}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small text-muted">Active Employees</span>
                            <span class="small text-muted">142</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Settings Content -->
        <div class="col-lg-9">
            <!-- Settings Form -->
            <div class="card dashboard-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-clock me-2"></i>Attendance Configuration
                    </h5>
                    <span class="badge bg-primary">Settings</span>
                </div>
                
                <div class="card-body">
                    <!-- Success Message -->
                    {% if messages %}
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        {% for message in messages %}
                            {{ message }}
                        {% endfor %}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}

                    <form method="post" id="settingsForm">
                        {% csrf_token %}
                        
                        <!-- Attendance Rules Section -->
                        <div class="settings-section mb-5" id="attendance-rules">
                            <div class="section-header mb-4">
                                <h6 class="section-title text-primary mb-2">
                                    <i class="fas fa-user-clock me-2"></i>Attendance Rules
                                </h6>
                                <p class="text-muted mb-0">Configure working hours, late policies, and attendance rules</p>
                            </div>

                            <div class="row g-3">
                                {% for field in form %}
                                    {% if "work_hours" in field.name or "late" in field.name or "overtime" in field.name %}
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                                {{ field.label }}
                                                {% if field.field.required %}
                                                    <span class="text-danger">*</span>
                                                {% endif %}
                                            </label>
                                            {% if field.field.widget.input_type == 'checkbox' %}
                                                <div class="form-check form-switch mt-2">
                                                    {{ field }}
                                                    <label class="form-check-label" for="{{ field.id_for_label }}">
                                                        {{ field.help_text }}
                                                    </label>
                                                </div>
                                            {% else %}
                                                {{ field }}
                                                {% if field.help_text %}
                                                    <div class="form-text text-muted">{{ field.help_text }}</div>
                                                {% endif %}
                                            {% endif %}
                                            {% if field.errors %}
                                                <div class="text-danger small mt-1">
                                                    {% for error in field.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Security Settings Section -->
                        <div class="settings-section mb-5" id="security-settings">
                            <div class="section-header mb-4">
                                <h6 class="section-title text-primary mb-2">
                                    <i class="fas fa-shield-alt me-2"></i>Security Settings
                                </h6>
                                <p class="text-muted mb-0">Configure facial recognition sensitivity and security parameters</p>
                            </div>

                            <div class="row g-3">
                                {% for field in form %}
                                    {% if "confidence" in field.name or "security" in field.name or "threshold" in field.name %}
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                                {{ field.label }}
                                                {% if field.field.required %}
                                                    <span class="text-danger">*</span>
                                                {% endif %}
                                            </label>
                                            
                                            {% if "confidence" in field.name %}
                                                <!-- Enhanced confidence threshold with visual indicator -->
                                                <div class="d-flex align-items-center">
                                                    {{ field }}
                                                    <div class="ms-3">
                                                        <div class="confidence-visual">
                                                            <div class="progress" style="width: 100px; height: 8px;">
                                                                <div class="progress-bar 
                                                                    {% if field.value >= 90 %}bg-success
                                                                    {% elif field.value >= 70 %}bg-warning
                                                                    {% else %}bg-danger{% endif %}" 
                                                                    style="width: {{ field.value|default:70 }}%">
                                                                </div>
                                                            </div>
                                                            <small class="text-muted d-block mt-1">{{ field.value|default:70 }}% threshold</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                {{ field }}
                                            {% endif %}
                                            
                                            {% if field.help_text %}
                                                <div class="form-text text-muted">{{ field.help_text }}</div>
                                            {% endif %}
                                            {% if field.errors %}
                                                <div class="text-danger small mt-1">
                                                    {% for error in field.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Notification Settings -->
                        <div class="settings-section mb-5" id="notification-settings">
                            <div class="section-header mb-4">
                                <h6 class="section-title text-primary mb-2">
                                    <i class="fas fa-bell me-2"></i>Notification Settings
                                </h6>
                                <p class="text-muted mb-0">Configure alerts and notifications for attendance events</p>
                            </div>

                            <div class="row g-3">
                                {% for field in form %}
                                    {% if "notification" in field.name or "alert" in field.name or "email" in field.name %}
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                                {{ field.label }}
                                            </label>
                                            {% if field.field.widget.input_type == 'checkbox' %}
                                                <div class="form-check form-switch mt-2">
                                                    {{ field }}
                                                    <label class="form-check-label" for="{{ field.id_for_label }}">
                                                        {{ field.help_text }}
                                                    </label>
                                                </div>
                                            {% else %}
                                                {{ field }}
                                                {% if field.help_text %}
                                                    <div class="form-text text-muted">{{ field.help_text }}</div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>

                        <!-- System Configuration -->
                        <div class="settings-section mb-4" id="system-config">
                            <div class="section-header mb-4">
                                <h6 class="section-title text-primary mb-2">
                                    <i class="fas fa-sliders-h me-2"></i>System Configuration
                                </h6>
                                <p class="text-muted mb-0">Advanced system settings and configurations</p>
                            </div>

                            <div class="row g-3">
                                {% for field in form %}
                                    {% if "work_hours" not in field.name and "late" not in field.name and "overtime" not in field.name and "confidence" not in field.name and "security" not in field.name and "threshold" not in field.name and "notification" not in field.name and "alert" not in field.name and "email" not in field.name %}
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                                {{ field.label }}
                                                {% if field.field.required %}
                                                    <span class="text-danger">*</span>
                                                {% endif %}
                                            </label>
                                            {{ field }}
                                            {% if field.help_text %}
                                                <div class="form-text text-muted">{{ field.help_text }}</div>
                                            {% endif %}
                                            {% if field.errors %}
                                                <div class="text-danger small mt-1">
                                                    {% for error in field.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="border-top pt-4 mt-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-outline-secondary" id="resetBtn">
                                        <i class="fas fa-undo me-2"></i>Reset to Defaults
                                    </button>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-primary">
                                        <i class="fas fa-eye me-2"></i>Preview Changes
                                    </button>
                                    <button type="submit" class="btn btn-primary px-4">
                                        <i class="fas fa-save me-2"></i>Save Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Settings Help Card -->
            <div class="card dashboard-card mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-question-circle me-2"></i>Need Help?
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-2">Documentation</h6>
                            <p class="text-muted small mb-3">
                                Read our comprehensive guide on attendance system configuration and best practices.
                            </p>
                            <button class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-book me-1"></i> View Documentation
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-2">Support</h6>
                            <p class="text-muted small mb-3">
                                Having trouble with settings? Contact our support team for assistance.
                            </p>
                            <button class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-headset me-1"></i> Contact Support
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.settings-section {
    padding-bottom: 2rem;
    border-bottom: 1px solid #e9ecef;
}

.settings-section:last-of-type {
    border-bottom: none;
}

.section-header {
    padding-bottom: 1rem;
}

.section-title {
    font-weight: 600;
    font-size: 1.1rem;
}

.form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border-radius: 0.5rem;
    border: 1px solid #d1d7dc;
    padding: 0.75rem 1rem;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.15);
}

.confidence-visual {
    min-width: 120px;
}

.list-group-item {
    border: none;
    padding: 1rem 1.25rem;
    font-weight: 500;
}

.list-group-item.active {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.list-group-item:not(.active):hover {
    background-color: rgba(67, 97, 238, 0.05);
}

.alert {
    border: none;
    border-radius: 0.75rem;
    border-left: 4px solid var(--success-color);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Smooth scroll for sidebar navigation
    const navLinks = document.querySelectorAll('.list-group-item[href^="#"]');
    
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all links
            navLinks.forEach(l => l.classList.remove('active'));
            // Add active class to clicked link
            this.classList.add('active');
            
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Reset to defaults button
    const resetBtn = document.getElementById('resetBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to reset all settings to default values? This action cannot be undone.')) {
                // This would typically make an API call to reset settings
                alert('Settings have been reset to default values.');
            }
        });
    }

    // Real-time confidence threshold update
    const confidenceField = document.querySelector('[id*="confidence"]');
    if (confidenceField) {
        confidenceField.addEventListener('input', function() {
            const value = this.value;
            const progressBar = this.closest('.form-group').querySelector('.progress-bar');
            const thresholdText = this.closest('.form-group').querySelector('.text-muted');
            
            if (progressBar) {
                progressBar.style.width = value + '%';
                
                // Update color based on value
                if (value >= 90) {
                    progressBar.className = 'progress-bar bg-success';
                } else if (value >= 70) {
                    progressBar.className = 'progress-bar bg-warning';
                } else {
                    progressBar.className = 'progress-bar bg-danger';
                }
            }
            
            if (thresholdText) {
                thresholdText.textContent = value + '% threshold';
            }
        });
    }

    // Form submission enhancement
    const settingsForm = document.getElementById('settingsForm');
    if (settingsForm) {
        settingsForm.addEventListener('submit', function(e) {
            // Add loading state to submit button
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            submitBtn.disabled = true;
            
            // Re-enable button after 2 seconds (in case of error)
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 2000);
        });
    }
});
</script>
{% endblock %}
