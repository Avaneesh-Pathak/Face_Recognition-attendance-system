{% extends "base.html" %}
{% load static %}

{% block page_title %}Organization Structure{% endblock %}

{% block content %}
<div class="card border-0 shadow-sm">
  <div class="card-header bg-white py-3">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
      <h5 class="mb-0 fw-bold text-dark"><i class="fas fa-sitemap me-2 text-primary"></i>My Org Chart</h5>

      <div class="d-flex flex-wrap gap-2">
        <!-- View switch -->
        <div class="btn-group shadow-sm" role="group">
          <button class="btn btn-outline-primary active" id="btnViewFull">
            <i class="fas fa-sitemap me-1"></i>Full View
          </button>
          <button class="btn btn-outline-primary" id="btnViewTeam">
            <i class="fas fa-users me-1"></i>Only My Team
          </button>
        </div>

        <!-- Print -->
        <button class="btn btn-outline-success shadow-sm" id="btnPrint">
          <i class="fas fa-print me-1"></i>Print
        </button>
      </div>
    </div>
  </div>

  <div class="card-body bg-light position-relative overflow-auto" style="min-height: 75vh;">
    <div class="alert alert-info border-0 shadow-sm d-inline-flex align-items-center py-2 px-3 mb-4">
      <i class="fas fa-info-circle me-2"></i>
      <small>Click the arrow on an employee card to expand/collapse their team.</small>
    </div>

    <!-- Chart container -->
    <div id="orgRoot" class="org-viewport mx-auto pb-5">
      <div class="text-center py-5" id="loadingState">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading your organization structure...</p>
      </div>
    </div>
  </div>
</div>

<style>
  /* Viewport */
  .org-viewport {
    display: flex;
    justify-content: center;
    padding: 2rem;
    min-width: max-content;
  }

  /* Tree Nodes Wrapper */
  .org-node-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    padding: 20px 10px 0 10px;
    transition: all 0.3s ease;
  }

  /* Card Styles */
  .org-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(0,0,0,0.05);
    width: 260px;
    padding: 1.25rem;
    position: relative;
    z-index: 2;
    transition: transform 0.2s;
  }
  .org-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    border-color: #cbd5e1;
  }
  
  /* Highlight Logged-in User */
  .org-card.is-current {
    border: 2px solid #3b82f6;
    background-color: #f0f7ff;
  }

  /* Node Content */
  .org-head { display: flex; align-items: center; gap: 1rem; }
  .org-avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 3px solid #f1f5f9; }
  .org-info .name { font-weight: 700; color: #1e293b; font-size: 0.95rem; margin-bottom: 0.1rem; }
  .org-info .position { font-size: 0.8rem; color: #64748b; font-weight: 500; }
  .org-info .dept { font-size: 0.7rem; color: #3b82f6; font-weight: 600; text-transform: uppercase; }

  /* Tree Connecting Lines (Pure CSS Magic) */
  .org-children {
    display: flex;
    justify-content: center;
    padding-top: 20px;
    position: relative;
  }

  /* Top down line from parent */
  .org-children::before {
    content: ''; position: absolute; top: 0; left: 50%;
    border-left: 2px solid #cbd5e1;
    width: 0; height: 20px; transform: translateX(-50%);
  }
  /* Vertical line rising from child */
  .org-node-wrapper::before {
    content: ''; position: absolute; top: 0; left: 50%;
    border-left: 2px solid #cbd5e1;
    width: 0; height: 20px; transform: translateX(-50%);
  }
  /* Horizontal line connecting siblings */
  .org-node-wrapper::after {
    content: ''; position: absolute; top: 0; left: 0;
    border-top: 2px solid #cbd5e1;
    width: 100%; height: 0;
  }
  .org-viewport:has(> .org-node-wrapper:only-child) {
    justify-content: center;
  }
  /* Adjust horizontal lines for first and last children */
  .org-children > .org-node-wrapper:first-child::after { left: 50%; width: 50%; }
  .org-children > .org-node-wrapper:last-child::after { left: 0; width: 50%; }
  /* No horizontal line if there's only one child */
  .org-children > .org-node-wrapper:only-child::after { display: none; }

  /* Remove top lines for root node */
  .org-viewport > .org-node-wrapper { padding-top: 0; }
  .org-viewport > .org-node-wrapper::before,
  .org-viewport > .org-node-wrapper::after { display: none; }

  /* Dropdown line coming out of the bottom of parent card */
  .org-card.has-children::after {
    content: ''; position: absolute; bottom: -20px; left: 50%;
    border-left: 2px solid #cbd5e1;
    width: 0; height: 20px; transform: translateX(-50%);
  }

  /* Toggle Button */
  .org-toggle-btn {
    position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%);
    background: #fff; border: 1px solid #cbd5e1; color: #64748b; border-radius: 50%;
    width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
    font-size: 10px; cursor: pointer; z-index: 10;
  }
  .org-toggle-btn:hover { background: #f8fafc; color: #3b82f6; border-color: #3b82f6; }
  .org-node-wrapper.collapsed > .org-children { display: none; }

  @media print {
    .sidebar, .top-header, .btn-group, .alert, .org-toggle-btn { display: none !important; }
    .main-content { margin: 0 !important; }
    .card { border: none !important; box-shadow: none !important; }
    .org-viewport { padding: 0; display: block; overflow: visible; }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const rootEl = document.getElementById('orgRoot');
    const btnFull = document.getElementById('btnViewFull');
    const btnTeam = document.getElementById('btnViewTeam');
    const btnPrint = document.getElementById('btnPrint');
    
    let rawTreeData = [];

    async function fetchData() {
      try {
        // CHANGED: Now points to the 'me' endpoint correctly mapped in urls.py
        const res = await fetch("{% url 'org_tree_api_me' %}");
        const data = await res.json();
        if (!data.ok) throw new Error("Failed");
        return data.tree;
      } catch (e) {
        rootEl.innerHTML = `<div class="text-center text-danger py-5"><i class="fas fa-exclamation-triangle fa-2x mb-3"></i><p>Failed to load structure data.</p></div>`;
        return null;
      }
    }

    function escapeHtml(str) {
      return (str ?? "").toString().replace(/[&<>"']/g, s => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[s]));
    }

    function createNodeCard(node) {
      const card = document.createElement('div');
      card.className = 'org-card' + (node.is_current ? ' is-current' : '');

      const avatarUrl = node.image || '{% static "images/default_profile.png" %}';

      card.innerHTML = `
        <div class="org-head">
          <img class="org-avatar" src="${avatarUrl}" alt="avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(node.name)}&background=random'">
          <div class="org-info">
            <div class="name">${escapeHtml(node.name || 'Unknown')}</div>
            <div class="position">${escapeHtml(node.position || '-')}</div>
            <div class="dept">${escapeHtml(node.department || '-')}</div>
          </div>
        </div>
        ${node.profile_url ? `
        <div class="mt-3 pt-2 border-top d-flex justify-content-end">
          <a class="btn btn-sm btn-light text-primary fw-medium rounded-pill px-3" href="${node.profile_url}" style="font-size: 0.75rem;">
            Profile <i class="fas fa-arrow-right ms-1"></i>
          </a>
        </div>` : ''}
      `;
      return card;
    }

    function renderNode(node) {
      const wrapper = document.createElement('div');
      wrapper.className = 'org-node-wrapper';

      const card = createNodeCard(node);
      wrapper.appendChild(card);

      if (node.children && node.children.length > 0) {
        card.classList.add('has-children');

        // Collapse/Expand button
        const toggleBtn = document.createElement('div');
        toggleBtn.className = 'org-toggle-btn';
        toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
        card.appendChild(toggleBtn);

        const childrenWrap = document.createElement('div');
        childrenWrap.className = 'org-children';

        node.children.forEach(child => {
          childrenWrap.appendChild(renderNode(child));
        });

        wrapper.appendChild(childrenWrap);

        // Click event to toggle team visibility
        toggleBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          wrapper.classList.toggle('collapsed');
          const icon = toggleBtn.querySelector('i');
          icon.className = wrapper.classList.contains('collapsed') ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
        });
      }
      return wrapper;
    }

    function renderTree(treeArray) {
      rootEl.innerHTML = '';
      if (!treeArray || treeArray.length === 0) {
        rootEl.innerHTML = '<div class="alert alert-warning">No organization chart data found.</div>';
        return;
      }
      treeArray.forEach(rootNode => {
        rootEl.appendChild(renderNode(rootNode));
      });
    }

    // Helper to find just the current logged in user to isolate "My Team"
    function findCurrentUserNode(nodes) {
      for (const node of nodes) {
        if (node.is_current) return node;
        if (node.children) {
          const found = findCurrentUserNode(node.children);
          if (found) return found;
        }
      }
      return null;
    }

    // Init process
    rawTreeData = await fetchData();

    if (rawTreeData) {
      // ðŸ”’ Normalize: force array even for single node
      if (!Array.isArray(rawTreeData)) {
        rawTreeData = [rawTreeData];
      }
      renderTree(rawTreeData);
    }

    // Button Logic
    btnFull.addEventListener('click', () => {
      btnFull.classList.add('active');
      btnTeam.classList.remove('active');
      renderTree(rawTreeData); // Renders CEO down to User down to Subordinates
    });

    btnTeam.addEventListener('click', () => {
      btnTeam.classList.add('active');
      btnFull.classList.remove('active');
      
      // Isolates tree so it ONLY starts from the logged in user downwards
      const myNode = findCurrentUserNode(rawTreeData);
      if (myNode) {
        renderTree([myNode]); 
      } else {
        renderTree(rawTreeData); // Fallback
      }
    });

    btnPrint.addEventListener('click', () => window.print());
  });
</script>
{% endblock %}