{% extends "base.html" %}
{% load static %}

{% block page_title %}Organization Structure{% endblock %}

{% block content %}
<div class="card border-0 shadow-sm">
  <div class="card-header bg-white py-3">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
      <h5 class="mb-0 fw-bold text-dark"><i class="fas fa-sitemap me-2 text-primary"></i>Interactive Chart</h5>

      <div class="d-flex flex-wrap gap-2">
        <!-- View switch -->
        <div class="btn-group shadow-sm" role="group">
          <button class="btn btn-outline-primary active" id="btnViewPath">
            <i class="fas fa-road me-1"></i>My Path
          </button>
          <button class="btn btn-outline-primary" id="btnViewTeam">
            <i class="fas fa-users me-1"></i>My Team
          </button>
        </div>

        <!-- Layout switch -->
        <div class="btn-group shadow-sm" role="group">
          <button class="btn btn-outline-secondary active" id="btnVertical" title="Vertical Layout">
            <i class="fas fa-arrow-down"></i>
          </button>
          <button class="btn btn-outline-secondary" id="btnHorizontal" title="Horizontal Layout">
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>

        <!-- Print -->
        <button class="btn btn-outline-success shadow-sm" id="btnPrint">
          <i class="fas fa-print me-1"></i>Print
        </button>
      </div>
    </div>
  </div>

  <div class="card-body bg-light min-vh-100 position-relative overflow-auto">
    <div class="alert alert-info border-0 shadow-sm d-inline-flex align-items-center py-2 px-3 mb-4">
      <i class="fas fa-info-circle me-2"></i>
      <small>Click on any employee card to expand/collapse their team.</small>
    </div>

    <!-- Chart container -->
    <div id="orgRoot" class="org-viewport vertical mx-auto">
      <!-- JS will render here -->
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading organization structure...</p>
      </div>
    </div>
  </div>
</div>

<style>
  /* Viewport toggles */
  .org-viewport.vertical {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2rem;
    padding: 2rem;
  }

  .org-viewport.horizontal {
    display: flex;
    align-items: flex-start;
    gap: 2rem;
    padding: 2rem;
    min-width: max-content;
  }

  /* Node card */
  .org-node {
    background: white;
    border-radius: 16px;
    box-shadow: var(--shadow-sm);
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    width: 280px;
    padding: 1.25rem;
    position: relative;
    z-index: 2;
  }

  .org-node:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary);
  }

  .org-node.toggleable {
    cursor: pointer;
  }

  /* Node Content */
  .org-head {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .org-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #f1f5f9;
    box-shadow: var(--shadow-sm);
  }

  .org-info .name {
    font-weight: 700;
    color: var(--dark);
    font-size: 1rem;
    margin-bottom: 0.2rem;
  }

  .org-info .position {
    font-size: 0.85rem;
    color: var(--secondary);
    font-weight: 500;
  }

  .org-info .dept {
    font-size: 0.75rem;
    color: var(--primary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 0.25rem;
  }

  /* Connectors */
  .connector-down {
    width: 2px;
    height: 2rem;
    background: #cbd5e1;
    margin: 0 auto;
    position: relative;
  }

  /* Children container */
  .children {
    display: none;
    gap: 2rem;
    justify-content: center;
    margin-top: 2rem;
    position: relative;
  }

  .children.show {
    display: flex;
    flex-wrap: wrap;
  }

  /* Connector Lines Logic (Simplified for CSS) */
  .node-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .horizontal .children {
    flex-direction: column;
    align-items: flex-start;
    margin-top: 0;
    margin-left: 2rem;
    border-left: 2px solid #cbd5e1;
    padding-left: 2rem;
  }

  .horizontal .org-node {
    margin-bottom: 1rem;
  }

  /* Print Styles */
  @media print {

    .sidebar,
    .top-header,
    .btn-group,
    .alert {
      display: none !important;
    }

    .main-content {
      margin: 0 !important;
    }

    .card {
      border: none !important;
      shadow: none !important;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const rootEl = document.getElementById('orgRoot');
    const btnPath = document.getElementById('btnViewPath');
    const btnTeam = document.getElementById('btnViewTeam');
    const btnVertical = document.getElementById('btnVertical');
    const btnHorizontal = document.getElementById('btnHorizontal');
    const btnPrint = document.getElementById('btnPrint');

    // Load JSON from API (current user)
    async function fetchData() {
      try {
        const res = await fetch("{% url 'org_tree_api_me' %}", { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const data = await res.json();
        if (!data.ok) throw new Error('Failed to load org tree');
        return data;
      } catch (e) {
        rootEl.innerHTML = `<div class="text-center text-danger py-5"><i class="fas fa-exclamation-circle fa-2x mb-2"></i><p>Failed to load data</p></div>`;
        throw e;
      }
    }

    // Utilities
    function createNodeCard(node, { toggleable = false }) {
      const card = document.createElement('div');
      card.className = 'org-node' + (toggleable ? ' toggleable' : '');

      const avatarUrl = node.image || '{% static "images/default_profile.png" %}';

      card.innerHTML = `
      <div class="org-head">
        <img class="org-avatar" src="${avatarUrl}" alt="avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(node.name)}&background=random'">
        <div class="org-info">
          <div class="name">${escapeHtml(node.name || 'Unknown')}</div>
          <div class="position">${escapeHtml(node.position || '-')}</div>
          <div class="dept">${escapeHtml(node.department || '-')}</div>
        </div>
      </div>
      ${node.profile_url ? `
      <div class="mt-3 pt-3 border-top d-flex justify-content-end">
        <a class="btn btn-sm btn-light text-primary fw-medium rounded-pill px-3" href="${node.profile_url}">
          Profile <i class="fas fa-arrow-right ms-1"></i>
        </a>
      </div>` : ''}
    `;
      return card;
    }

    function escapeHtml(str) {
      return (str ?? "").toString().replace(/[&<>"']/g, s => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[s]));
    }

    // PATH VIEW (CEO -> ... -> You)
    function renderPath(path) {
      rootEl.classList.remove('horizontal');
      rootEl.classList.add('vertical');
      rootEl.innerHTML = '';

      path.forEach((n, idx) => {
        const card = createNodeCard(n, { toggleable: false });
        rootEl.appendChild(card);
        if (idx < path.length - 1) {
          const c = document.createElement('div');
          c.className = 'connector-down';
          rootEl.appendChild(c);
        }
      });
    }

    // TEAM TREE (You -> all subordinates)
    function renderTeam(root) {
      rootEl.innerHTML = '';

      function renderNode(node) {
        const wrapper = document.createElement('div');
        wrapper.className = 'node-wrapper';

        const card = createNodeCard(node, { toggleable: true });
        wrapper.appendChild(card);

        const childrenWrap = document.createElement('div');
        childrenWrap.className = 'children';
        wrapper.appendChild(childrenWrap);

        card.addEventListener('click', (e) => {
          if (e.target.closest('a')) return;
          childrenWrap.classList.toggle('show');
        });

        if (Array.isArray(node.children) && node.children.length > 0) {
          // Add connector if there are children
          if (rootEl.classList.contains('vertical')) {
            // Logic for visual connectors would go here, simplified for now
          }

          node.children.forEach(child => {
            const childBlock = renderNode(child);
            childrenWrap.appendChild(childBlock);
          });

          // Auto-expand first level
          childrenWrap.classList.add('show');
        }
        return wrapper;
      }

      if (root) {
        const block = renderNode(root);
        rootEl.appendChild(block);
      } else {
        rootEl.innerHTML = '<div class="text-center text-muted">No team data available</div>';
      }
    }

    function setVertical() {
      rootEl.classList.remove('horizontal');
      rootEl.classList.add('vertical');
      btnVertical.classList.add('active');
      btnHorizontal.classList.remove('active');
    }
    function setHorizontal() {
      rootEl.classList.remove('vertical');
      rootEl.classList.add('horizontal');
      btnHorizontal.classList.add('active');
      btnVertical.classList.remove('active');
    }

    btnPrint.addEventListener('click', () => {
      window.print();
    });

    const data = await fetchData();

    // Default view: Path
    if (data.path) renderPath(data.path);

    btnPath.addEventListener('click', () => {
      btnPath.classList.add('active');
      btnTeam.classList.remove('active');
      setVertical();
      if (data.path) renderPath(data.path);
    });

    btnTeam.addEventListener('click', () => {
      btnTeam.classList.add('active');
      btnPath.classList.remove('active');
      setVertical();
      if (data.team) renderTeam(data.team);
    });

    btnVertical.addEventListener('click', setVertical);
    btnHorizontal.addEventListener('click', setHorizontal);
  });
</script>
{% endblock %}